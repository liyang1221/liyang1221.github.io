---
layout: post
title:  "Unity3D RenderTexture的坑"
date:   2016-03-08
categories: Unity
tags: Unity Problem
---

今天是伟大的妇女节，一到中午，办公室的女同事们就美滋滋地拿着公司发的购物卡享受带薪休假Shopping去了，结果就剩我一个人孤苦伶仃地填坑啦~

###项目在iPhone上运行黑屏，画面消失，但是程序还在跑
背景是我们的项目要发布iOS平台啦，由于前期我已经在iPad上面部署过了，感觉应该没啥问题，于是立项正式开搞。

结果今天我拿一台iPhone 5S部署了下，傻眼了，发现启动不起来。

具体现象就是启动后黑屏，后来发现是因为整个界面都没有显示出来，但是程序还是在跑的（因为我点屏幕能调出来系统键盘，证明输入框的功能还在，只是看不到）。
比较诡异的是，我之前已经在若干台iPad和一台iPhone6 plus上部署过是没有问题的，现在突然出现这样的问题，搞得我一时不知该从何下手了。后来Google之，只找到了一篇[一样的内容][1]，而且没有答案。
于是就新建了个测试场景，只有一张背景图和一个按钮，测试是可以显示的，但是如果点击按钮跳转到项目的登录场景，则现象是测试场景仍然显示在屏幕上，但是逻辑功能已经切换到登录场景了（点击屏幕可以跳出键盘）。

难道是Application.LoadLevel的问题？

于是用两个测试场景互相跳转，然而一切正常，没有任何问题。

我这个郁闷啊，各种设想问题所在，比如Canvas的叠加啦、相机的设定啦、Resources.Load动态加载啦、场景太大加载太慢啦、设备太差贴图太大等等，然并卵。。

到这里我也是没啥好办法啦，就用最笨的办法，屏蔽了场景大部分元素，只留下背景图，然后一点点恢复，定位罪魁祸首。

于是就定位到了它：[RenderTexture][2]。因为我们项目中采用了RenderTexture来将人物显示在UI上，UI是一开始就显示的，但是人物要等到登录完成拉取数据后才生成。整个流程是：

> 登录->生成人物模型->生成相机渲染人物到RenderTexture->显示在UI上

也就是说，在登录完成之前，UI显示的那张RenderTexture贴图是空的。

最后的解决方案很简单，在一开始就初始化人物相机，这时候虽然人物头像界面依然是空的，但是RenderTexture数据并不是空的。因此界面可以正常显示。

其实这个问题以前一直存在，但是为什么之前没有解决呢？因为在别的平台（PC、android、甚至iOS平台别的设备）上并没有造成这个后果。当然，还是会有一些小问题的，比如最典型的现象是，当RenderTexture数据为空时，会将一些当前界面的元素显示出来（比如登录框等等），造成头像部分看起来比较怪异。然而这种出现几率并不大（因为游戏设计有免登陆系统），所以被无视了。

最终得到的教训就是，切忌盲目信任平台一致性，unity的一些行为，尤其是渲染相关的东西，即使是相同系统平台，不同硬件设备也可能出现不同的差异性。所以发布时一定要尽量真机测试尽可能多的设备。
 
 
  [1]: http://www.tasharen.com/forum/index.php?topic=711.0
  [2]: http://docs.unity3d.com/ScriptReference/RenderTexture.html