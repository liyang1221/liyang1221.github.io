---
layout: post
title:  "Unity3D学习笔记：7，粒子系统"
date:   2015-04-10
categories: Unity
tags: Unity StudyLine
---

###粒子系统
在游戏中，大部分的角色、道具、场景等都是通过网格（mesh，3D）或者精灵（sprite，2D）来呈现的，它们用来呈现此类外形固定的物体是比较完美的。然而，游戏中常常还会有另一类外观不固定，极易变化的物体，比如液体、烟雾、火焰、烟花等，使用网格或者精灵是很难呈现的。这类效果一般使用称作“粒子系统”的技术来表现。<br>
“粒子”通常是微小的图片或网格，通过粒子系统来呈现和驱动。大量粒子集体参与运动，最终呈现出让人亮瞎狗眼的视觉效果。<br>
Unity内置了完善的粒子系统编辑器，通过这个复杂的编辑器，可以详细调节粒子系统的各个参数，并能实时预览效果，可以方便地帮助设计人员快速设计出想要的粒子特效。<br>
Unity的粒子系统也是作为物体的组件提供。想要添加粒子系统的物体，只需要附加对应的组件即可。由于历史原因，类似动画系统，粒子系统也有新旧两种版本。旧版本的粒子系统分为4个独立组件：<br>
Particle Emitter：负责粒子的发射；<br>
Particle Renderer：负责粒子的渲染；<br>
Particle Animator：负责粒子的动画效果；<br>
Particle Collider：负责粒子运行过程中碰撞检测的实现；<br>
而新版则将这些功能合并为一个组件Particle System，并增加了更丰富的设定选项。<br><br>

新版的ParticleSystem由于设置项太过复杂，专门有一个独立的设置窗口可以进行各项设置。在物体上添加ParticleSystem组件后，在Inspector窗口即可进行设置，或者点击『Open Editor』打开设置窗口进行设置。<br><br>

第一个设置项命名为ParticleSystem挂载的物体的名称，里面是粒子系统的常规设置内容，包括：<br>
Duration：粒子系统发射时常（秒），到时间后粒子系统将停止发射（如果未勾选Looping）；<br>
Looping：是否重复发射；<br>
Prewarm：是否预热。粒子系统从开始发射到达到稳定状态有个时间，如果勾选”预热“，则跳过这段时间；<br>
Start Delay：启动延迟时间（秒），即粒子系统启动后等待发射的时间；<br>
Start Lifetime：每个粒子的生命期（秒），粒子发射后经过这么长时间将会被销毁。此参数可以选择固定值或者曲线值或者一定范围的随机值等，在参数输入区右侧有个下拉小三角，点击即可选择类型。下面有些参数也是这样，不再累述；<br>
Start Speed：每个粒子的启动速度，即粒子发射时的初速度（米/每秒）；<br>
Start Size：每个粒子的启动大小，即粒子发射时的初始大小；<br>
Start Rotation：每个粒子的启动旋转角度，即粒子发射时的初始旋转角度；<br>
Start Color：每个粒子的启动颜色，即粒子发射时的初始颜色；<br>
Gravity Modifier：设置粒子受重力影响的比例（相对与场景的标准重力），比如1.0表示受标准重力影响，0表示不受重力影响；<br>
Inherit Velocity：每个粒子继承粒子系统的速度；当粒子的模拟空间是”世界“时才生效，粒子最终的运动速度是粒子速度/粒子系统速度和这个值3者的和；<br>
Simulation Space：粒子的模拟空间（本地/世界）。如果是本地，则粒子的最终运动是它自身和粒子系统运动的和，如果是世界，则粒子系统的运动不会影响到粒子的运动；<br>
Play On Awake：是否创建后立即运行；（如果否，需要通过脚本启动）；<br>
Max Particles：允许同时存在的最多粒子数目（当同时存在的粒子超过这个数目，发射器将会暂停发射，直到某些粒子被销毁）；<br><br>

除了一般的设置项，下面的类别中，最基本的两项是”Emission”和“Renderer”，即发射器和渲染器。发射器负责粒子的发射，渲染器负责粒子的渲染，他们如果不存在或被禁用，粒子系统是无法显示出来的。<br>
Emission的设置项相对较少，只有两项。“Rate”用来设置发射速度，即每秒（或每米，只有粒子系统移动中才生效）发射的粒子数目。“Bursts”设置某一时刻粒子系统可以瞬间发射大量粒子，一般用来模拟爆炸等。可以添加多个Burst。<br>
Renderer选项卡可以集中设置粒子渲染相关的选项：<br>
Render Mode：渲染类型。Billboard表示粒子始终面对摄像机，适合表现大多数的粒子效果；Stretched Billboard与Billboard类似，但是选择它的话，可以使用『Camera Scale、Speed Scale、Length Scale』来对粒子的行为进行进一步的修正；Horizontal Billboard将粒子渲染在XZ平面内，适合表现平铺在地面上的效果；Vertical Billboard将粒子渲染在垂直于XZ的平面内，但它会始终面向摄像机渲染；而Mesh则使用网格替代图片来渲染粒子。<br>
Normal Direction：粒子的法线方向，取值范围为0-1,1代表法线指向摄像机，0代表法线指向屏幕中心。默认为1。<br>
Material：用来渲染粒子的材质；<br>
Sort Mode：不同粒子间重叠时的渲染顺序。可根据距离或者产生时间来排列；<br>
Sorting Fudge：控制粒子与别的有透明通道的物体叠加时的渲染顺序。越小的值代表粒子与别的物体叠加时越容易显示在前面；<br>
Cast Shadows：粒子是否投射阴影到别的物体；<br>
Receive Shadows：别的物体的阴影是否可以投射到粒子上；<br>
Max Particle Size：控制粒子可以在屏幕上显示的最大尺寸，1表示整个屏幕，0.5表示屏幕一半大小的区域，依此类推（忽略其它设置项）；<br><br>

此外还有其他一些选项卡：<br><br>

Shape：用来控制粒子发射区域，使用一个特定形状和大小来表示。可选的形状包括Sphere（球体）、Hemisphere（半球）、Cone（圆锥）、Box（方体）、Circle（平面圆形）、Edge（平面线条）和Mesh（网格体）。每个不同的形状都有各自的参数可以调节，诸如Radius/Angle等。此外，还可以选择每个粒子初始时是否随机方向（Random Direction）。<br><br>

Collision：控制粒子与其它碰撞器的作用。启用此模块可以为粒子增加碰撞反馈效果。有两种可选的碰撞模式：World和Planes。选择“World”则粒子将和场景内的其它碰撞器参与碰撞检测（可选碰撞层），而选择Planes，则可以添加若干虚拟的“Plane”来控制粒子的碰撞（将忽略场景中的碰撞器）。“Plane”是在本地坐标系XZ平面无限扩展的虚拟平面，且只与它添加到的粒子系统进行碰撞作用。其它一些选项包括：<br>
Dampen：粒子参与碰撞后将减少的速度百分比；<br>
Bounce：粒子参与碰撞后将反弹的速度百分比；<br>
Lifetime Loss：粒子参与碰撞后损失的生命周期百分比；<br>
Min Kill Speed：当粒子的速度低于此限制时，参与碰撞后将直接被销毁；<br>
Collision Quality：碰撞“质量”，此值越低，有越大的概率粒子会直接无视碰撞器穿过其它物体；<br>
Send Collision Messages：勾选此项后，当粒子与其它碰撞器碰撞，两者物体上附加的任何脚本都会收到OnParticleCollision函数回调，以方便进行一些自定义处理。<br><br>

Velocity over Lifetime：在粒子整个生命周期中给它附加速度（可选本地或世界）；<br>
Limit Velocity over Lifetime：在粒子整个生命周期中，如果速度超过某个限制，就抑制它的速度；<br>
Force over Lifetime：在粒子整个生命周期中给它附加力（可选本地或世界）；<br>
Color over Lifetime：在粒子整个生命周期中控制它的颜色；<br>
Color by Speed：根据粒子的速度调整它的颜色；<br>
Size over Lifetime：控制粒子生命周期中的尺寸变化；<br>
Size by Speed：根据粒子的速度调整它的尺寸；<br>
Rotation over Lifetime：在粒子整个生命周期中给它附加角速度；<br>
Rotation by Speed：根据粒子的速度调整它的角速度；<br>
External Force：如果启用这个模块，则粒子可以受到Wind Zone（风区）的影响，且可以选择影响的程度。Wind Zone是Terrain（地形）系统中可选的内容，此区域内的物体都会受到类似风吹的作用力。<br>
Sub Emitters：可以在粒子生命周期的不同阶段附加新的粒子系统，当粒子达到此阶段时，附加的粒子系统会自动启动。共用3个可用的阶段：Birth/Collision和Death，每个阶段最多可以附加两个粒子系统。此选项适合组合多个粒子系统协同工作，简化使用代码控制的繁琐。举个板栗，如果有一个子弹发射的粒子系统，则可以在Birth阶段附加一个枪口冒烟的粒子系统，在子弹射入物体（也就是Death）阶段附加一个小的爆炸效果。<br>
Texture Sheet Animation：可以控制发射粒子的动画效果。它假设指定给粒子的图片是一张多帧动画的网格拼图，然后可以在粒子的生命周期内切换渲染粒子的图片区域。Tiles参数指定图片的行列，按照这个参数将大图切成若干小图；Animation可以指定『Whole Sheet』或者『Single Row』两种类型，前者在整个图片队列中动画，后者则只选择某一行进行动画；Frame over Time可以控制在粒子生命周期内图片帧的切换顺序；Cycles指定动画播放速度，1表示在粒子系统的一次持续发射期动画播放一次，2表示播放2次，依此类推。<br><br>

要想制作出令人叹为观止的粒子系统特效，除了熟悉上面每个参数的作用，还需要对要制作的效果的整体运行规律和各个细节都非常熟悉，而且要经过大量练习来熟悉每个参数对整体效果会造成的影响以及各个参数之间互相的作用效果等，建议程序同学了解这块即可，无需深入研究。此外，有一些第三方的粒子系统插件，如FX Maker等，本身自带了大量常见的粒子效果可以使用或者学习，而且对简化制作流程等有一些帮助，有兴趣可以体验一下。<br>